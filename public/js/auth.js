// ── Auth Page Logic (with theme support) ─────────────────

(function () {
  // If already logged in, redirect to app
  if (localStorage.getItem('haven_token')) {
    window.location.href = '/app';
    return;
  }

  // ── E2E wrapping key derivation (mirrors HavenE2E.deriveWrappingKey) ───
  async function deriveE2EWrappingKey(password) {
    const enc = new TextEncoder();
    const raw = await crypto.subtle.importKey(
      'raw', enc.encode(password), 'PBKDF2', false, ['deriveBits']
    );
    const bits = await crypto.subtle.deriveBits(
      { name: 'PBKDF2', hash: 'SHA-256', salt: enc.encode('haven-e2e-wrapping-v3'), iterations: 210_000 },
      raw, 256
    );
    return Array.from(new Uint8Array(bits)).map(b => b.toString(16).padStart(2, '0')).join('');
  }

  // ── Theme switching ───────────────────────────────────
  initThemeSwitcher('auth-theme-bar');

  // ── Fetch and display server version ──────────────────
  fetch('/api/version').then(r => r.json()).then(d => {
    const el = document.getElementById('auth-version');
    if (el && d.version) el.textContent = 'v' + d.version;
  }).catch(() => {});

  // ── EULA ─────────────────────────────────────────────
  const ageCheckbox  = document.getElementById('age-checkbox');
  const eulaCheckbox = document.getElementById('eula-checkbox');
  const eulaModal = document.getElementById('eula-modal');
  const eulaLink = document.getElementById('eula-link');
  const eulaAcceptBtn = document.getElementById('eula-accept-btn');
  const eulaDeclineBtn = document.getElementById('eula-decline-btn');

  // Restore EULA acceptance from localStorage (v2.0 requires re-acceptance)
  if (localStorage.getItem('haven_eula_accepted') === '2.0') {
    eulaCheckbox.checked = true;
    ageCheckbox.checked  = true;
  }

  eulaLink.addEventListener('click', (e) => {
    e.preventDefault();
    eulaModal.style.display = 'flex';
  });

  eulaAcceptBtn.addEventListener('click', () => {
    eulaCheckbox.checked = true;
    ageCheckbox.checked  = true;
    localStorage.setItem('haven_eula_accepted', '2.0');
    eulaModal.style.display = 'none';
  });

  eulaDeclineBtn.addEventListener('click', () => {
    eulaCheckbox.checked = false;
    ageCheckbox.checked  = false;
    localStorage.removeItem('haven_eula_accepted');
    eulaModal.style.display = 'none';
  });

  eulaModal.addEventListener('click', (e) => {
    if (e.target === e.currentTarget) eulaModal.style.display = 'none';
  });

  function checkEula() {
    if (!ageCheckbox.checked) {
      showError('You must confirm that you are 18 years of age or older');
      return false;
    }
    if (!eulaCheckbox.checked) {
      showError('You must accept the Terms of Service & Release of Liability Agreement');
      return false;
    }
    return true;
  }

  // ── Tab switching ─────────────────────────────────────
  const tabs = document.querySelectorAll('.auth-tab');
  const loginForm = document.getElementById('login-form');
  const registerForm = document.getElementById('register-form');
  const totpForm = document.getElementById('totp-form');
  const errorEl = document.getElementById('auth-error');

  // Pending TOTP challenge state (set after successful password auth)
  let _pendingChallenge = null; // { challengeToken, password }

  function showTotpForm() {
    loginForm.style.display = 'none';
    registerForm.style.display = 'none';
    totpForm.style.display = 'flex';
    document.querySelector('.auth-tabs').style.display = 'none';
    document.getElementById('totp-code').value = '';
    document.getElementById('totp-code').focus();
    hideError();
  }

  function hideTotpForm() {
    totpForm.style.display = 'none';
    loginForm.style.display = 'flex';
    document.querySelector('.auth-tabs').style.display = 'flex';
    _pendingChallenge = null;
    hideError();
  }

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');

      const target = tab.dataset.tab;
      loginForm.style.display = target === 'login' ? 'flex' : 'none';
      registerForm.style.display = target === 'register' ? 'flex' : 'none';
      totpForm.style.display = 'none';
      hideError();
    });
  });

  function showError(msg) {
    errorEl.textContent = msg;
    errorEl.style.display = 'block';
  }

  function hideError() {
    errorEl.style.display = 'none';
  }

  // ── Admin Recovery ────────────────────────────────────
  document.addEventListener('click', async (e) => {
    if (e.target.id !== 'admin-recover-btn') return;
    hideError();
    const username = document.getElementById('login-username').value.trim();
    const password = document.getElementById('login-password').value;
    if (!username || !password) return showError('Enter your admin username and password above first');
    try {
      const res = await fetch('/api/auth/admin-recover', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });
      const data = await res.json();
      if (!res.ok) return showError(data.error || 'Recovery failed');
      const e2eWrap = await deriveE2EWrappingKey(password);
      sessionStorage.setItem('haven_e2e_wrap', e2eWrap);
      localStorage.setItem('haven_token', data.token);
      localStorage.setItem('haven_user', JSON.stringify(data.user));
      window.location.href = '/app';
    } catch {
      showError('Connection error');
    }
  });

  // ── Login ─────────────────────────────────────────────
  loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    hideError();
    if (!checkEula()) return;

    const username = document.getElementById('login-username').value.trim();
    const password = document.getElementById('login-password').value;

    if (!username || !password) return showError('Fill in all fields');

    try {
      const res = await fetch('/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password, eulaVersion: '2.0', ageVerified: true })
      });

      const data = await res.json();
      if (!res.ok) return showError(data.error || 'Login failed');

      // ── TOTP challenge ──
      if (data.requiresTOTP) {
        _pendingChallenge = { challengeToken: data.challengeToken, password };
        showTotpForm();
        return;
      }

      // Derive E2E wrapping key from password (client-side only, never sent to server)
      const e2eWrap = await deriveE2EWrappingKey(password);
      sessionStorage.setItem('haven_e2e_wrap', e2eWrap);

      localStorage.setItem('haven_token', data.token);
      localStorage.setItem('haven_user', JSON.stringify(data.user));
      localStorage.setItem('haven_eula_accepted', '2.0');
      window.location.href = '/app';
    } catch (err) {
      showError('Connection error — is the server running?');
    }
  });

  // ── TOTP verification ────────────────────────────────
  totpForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    hideError();
    if (!_pendingChallenge) return showError('Session expired — please log in again');

    const code = document.getElementById('totp-code').value.trim();
    if (!code) return showError('Enter your authentication code');

    try {
      const res = await fetch('/api/auth/totp/validate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ challengeToken: _pendingChallenge.challengeToken, code })
      });

      const data = await res.json();
      if (!res.ok) return showError(data.error || 'Verification failed');

      // Derive E2E wrapping key from the original password
      const e2eWrap = await deriveE2EWrappingKey(_pendingChallenge.password);
      sessionStorage.setItem('haven_e2e_wrap', e2eWrap);

      localStorage.setItem('haven_token', data.token);
      localStorage.setItem('haven_user', JSON.stringify(data.user));
      localStorage.setItem('haven_eula_accepted', '2.0');
      _pendingChallenge = null;
      window.location.href = '/app';
    } catch (err) {
      showError('Connection error — is the server running?');
    }
  });

  // Toggle between TOTP code and backup code mode
  const totpCodeInput = document.getElementById('totp-code');
  const backupToggle = document.getElementById('totp-use-backup');
  let _backupMode = false;
  if (backupToggle) {
    backupToggle.addEventListener('click', (e) => {
      e.preventDefault();
      _backupMode = !_backupMode;
      if (_backupMode) {
        totpCodeInput.placeholder = 'XXXX-XXXX';
        totpCodeInput.maxLength = 9;
        totpCodeInput.inputMode = 'text';
        totpCodeInput.pattern = '';
        backupToggle.textContent = 'Use authenticator code instead';
      } else {
        totpCodeInput.placeholder = '000000';
        totpCodeInput.maxLength = 6;
        totpCodeInput.inputMode = 'numeric';
        totpCodeInput.pattern = '[0-9]*';
        backupToggle.textContent = 'Use a backup code instead';
      }
      totpCodeInput.value = '';
      totpCodeInput.focus();
    });
  }

  // Back to login from TOTP form
  const totpBackBtn = document.getElementById('totp-back-btn');
  if (totpBackBtn) {
    totpBackBtn.addEventListener('click', (e) => {
      e.preventDefault();
      hideTotpForm();
    });
  }

  // ── Register ──────────────────────────────────────────
  registerForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    hideError();
    if (!checkEula()) return;

    const username = document.getElementById('reg-username').value.trim();
    const password = document.getElementById('reg-password').value;
    const confirm = document.getElementById('reg-confirm').value;

    if (!username || !password || !confirm) return showError('Fill in all fields');
    if (password !== confirm) return showError('Passwords do not match');
    if (password.length < 8) return showError('Password must be at least 8 characters');

    try {
      const res = await fetch('/api/auth/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password, eulaVersion: '2.0', ageVerified: true })
      });

      const data = await res.json();
      if (!res.ok) return showError(data.error || 'Registration failed');

      // Derive E2E wrapping key from password (client-side only, never sent to server)
      const e2eWrap = await deriveE2EWrappingKey(password);
      sessionStorage.setItem('haven_e2e_wrap', e2eWrap);

      localStorage.setItem('haven_token', data.token);
      localStorage.setItem('haven_user', JSON.stringify(data.user));
      localStorage.setItem('haven_eula_accepted', '2.0');
      window.location.href = '/app';
    } catch (err) {
      showError('Connection error — is the server running?');
    }
  });
})();
